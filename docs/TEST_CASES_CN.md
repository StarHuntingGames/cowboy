# Cow Boy 测试用例

最后更新: 2026-02-14

## V1 前端游戏玩法（手动测试）

### TC-V1-001: 开始比赛与初始回合
- 前置条件: 打开 `http://localhost:8000`。
- 操作步骤:
1. 点击 `Start`。
- 预期结果:
1. 回合面板显示当前活跃玩家 `Player A (Up)`。
2. `Execute` 按钮可用。
3. 日志显示比赛已开始，回合顺序为 `Up -> Left -> Down -> Right`。

### TC-V1-002: 移动操作
- 前置条件: 比赛已开始，当前活跃玩家为 A。
- 操作步骤:
1. 选择指令 `move`。
2. 选择方向 `down`。
3. 点击 `Execute`。
- 预期结果:
1. 如果目标格子为空，玩家 A 向下移动一格。
2. 活跃玩家切换为玩家 B。
3. 日志中包含移动结果。

### TC-V1-003: 移动被障碍方块阻挡
- 前置条件: 比赛已开始；当前活跃玩家在所选方向上相邻位置存在障碍方块。
- 操作步骤:
1. 选择指令 `move`。
2. 选择被阻挡的方向。
3. 点击 `Execute`。
- 预期结果:
1. 玩家留在原来的格子。
2. 日志说明移动被阻挡。
3. 回合仍然推进。

### TC-V1-004: 射击摧毁有限强度的方块
- 前置条件: 射击者对强度为 `1` 或 `2` 的方块拥有直线视野。
- 操作步骤:
1. 选择指令 `shoot`。
2. 选择朝向该方块的方向。
3. 点击 `Execute`。
- 预期结果:
1. 激光在直线上遇到的第一个阻挡物处停止。
2. 方块强度降低；如果降至 0，方块被移除。
3. 日志记录方块被命中/摧毁。

### TC-V1-005: 射击被无限强度方块阻挡
- 前置条件: 射击者对 `-1` 强度方块拥有直线视野。
- 操作步骤:
1. 选择指令 `shoot`。
2. 选择朝向 `-1` 方块的方向。
3. 点击 `Execute`。
- 预期结果:
1. 激光在 `-1` 方块处停止。
2. 方块保持不变。
3. 该方块后方的玩家不会受到伤害。

### TC-V1-006: 护盾操作与受保护的射击
- 前置条件: 目标玩家与攻击者在同一行或同一列。
- 操作步骤:
1. 在目标玩家的回合中，将护盾方向设为面向攻击者并执行 `shield`。
2. 在攻击者的回合中，向目标玩家执行 `shoot`。
- 预期结果:
1. 受保护的目标不会失去生命值。
2. 受保护的目标不会触发震动/音效。
3. 日志报告护盾保护。

### TC-V1-007: 自身护盾方向射击规则
- 前置条件: 当前活跃玩家的护盾朝向某个方向。
- 操作步骤:
1. 选择 `shoot`，方向与自身护盾方向相同。
2. 点击 `Execute`。
- 预期结果:
1. 射击被游戏规则拒绝。
2. 不会造成激光伤害。
3. 日志说明射击方向无效。

### TC-V1-008: 回合顺序与轮次递增
- 前置条件: 比赛已开始。
- 操作步骤:
1. 依次为 A、B、C、D 各执行一个操作。
- 预期结果:
1. 回合顺序保持为 `A -> B -> C -> D`。
2. D 操作完成后，轮次递增 1，下一个活跃玩家为 A。

### TC-V1-009: 最后存活者获胜
- 前置条件: 比赛进行中，部分玩家生命值较低。
- 操作步骤:
1. 持续执行操作，直到只剩一名玩家存活。
- 预期结果:
1. 游戏状态变更为已结束。
2. 日志/回合面板中公布获胜者。
3. 后续的执行操作被禁止。

## V2 后端 API（自动化/手动测试）

### TC-V2-001: 使用默认地图创建游戏
- 接口: `POST /v2/games`
- 输入: `{ "turn_timeout_seconds": 10 }`
- 预期结果:
1. 返回 `200` 响应，`status=CREATED`。
2. `map_source=DEFAULT`。
3. `turn_no=1`，`round_no=1`，`current_player_id=up`。

### TC-V2-002: 使用自定义地图创建游戏
- 接口: `POST /v2/games`
- 输入: 包含 `map` 字段。
- 预期结果:
1. 返回 `200` 响应，`map_source=CUSTOM`。
2. 存储的游戏状态地图与输入的尺寸/内容一致。

### TC-V2-003: 启动游戏
- 接口: `POST /v2/games/{game_id}/start`
- 预期结果:
1. 第一次调用设置 `status=RUNNING`，`started=true`。
2. 第二次调用返回 `started=false`，原因为 `ALREADY_RUNNING`。

### TC-V2-004: 提交指令验证
- 接口: `POST /v2/games/{game_id}/commands`
- 输入变体:
1. `command_type=timeout`（用户不可使用的无效类型）。
2. `move/shield/shoot` 缺少 `direction` 字段。
- 预期结果:
1. 无效用户指令类型返回 `400`。
2. 缺少必需的方向字段时返回 `400`。

### TC-V2-005: 提交有效指令
- 接口: `POST /v2/games/{game_id}/commands`
- 输入: 有效的 `move|shield|shoot` 指令，附带方向。
- 预期结果:
1. 返回 `200`，`accepted=true`。
2. 响应中包含相同的 `command_id`。

### TC-V2-006: 观察者服务健康检查接口
- 接口: `GET /health`（观察者服务）。
- 预期结果:
1. 返回 `200`，内容为 `{ "ok": true, "service": "game-watcher-service" }`。

### TC-V2-007: 观察者快照
- 接口: `GET /v2/games/{game_id}/snapshot`
- 预期结果:
1. 返回 `200`，包含最新的地图/玩家快照。
2. 包含 `status`、`turn_no`、`round_no`、`current_player_id` 字段。
3. 如果游戏已结束，`status=FINISHED`。

### TC-V2-008: 结束状态转换与观察者事件
- 前置条件: 正在进行的游戏中有两名低生命值玩家。
- 操作步骤:
1. 提交一个有效的 `shoot` 指令，消灭倒数第二名存活玩家。
2. 调用观察者快照接口。
3. 观察同一游戏的观察者 WebSocket 数据流。
- 预期结果:
1. Game Service 将游戏状态转换为 `FINISHED`。
2. 快照响应返回 `status=FINISHED`。
3. WebSocket 发送 `GAME_FINISHED` 事件。
4. 前端显示获胜者信息和结束动画。

## 当前自动化测试覆盖范围
- `cowboy-common`:
1. 出生点位于边缘中心位置。
2. 生成地图的安全出生格子。
3. 生成地图的值域（`-1,0,1,2`）。
4. 内置默认地图的形状与安全出生格子。
- `web-service`:
1. 指令验证规则。
2. 成功发布路径。
3. 发布者失败路径。
- `game-manager-service`:
1. 使用默认/自定义地图创建游戏的流程。
2. 启动幂等性行为。
3. 未找到游戏的行为。
4. 默认地图获取稳定性。
- `game-watcher-service`:
1. 健康检查响应内容。
2. 基于 `turn_no` 游标语义的快照转换。
