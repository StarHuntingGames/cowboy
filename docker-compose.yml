# Copyright (C) 2026 StarHuntingGames
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.7.1
    depends_on:
      - zookeeper
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

  kafka-init:
    image: confluentinc/cp-kafka:7.7.1
    depends_on:
      - kafka
    entrypoint:
      - /bin/sh
      - -lc
      - |
        cub kafka-ready -b kafka:9092 1 60
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic game.commands.v1 --partitions 1 --replication-factor 1
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic game.steps.v1 --partitions 1 --replication-factor 1
        echo "Kafka topics ensured."

  dynamodb:
    image: amazon/dynamodb-local:2.5.2
    command: "-jar DynamoDBLocal.jar -sharedDb -inMemory"

  dynamodb-init:
    image: amazon/aws-cli:2.17.54
    depends_on:
      - dynamodb
    environment:
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      AWS_DEFAULT_REGION: us-east-1
    entrypoint:
      - /bin/sh
      - -lc
      - |
        set -e
        aws dynamodb create-table \
          --endpoint-url http://dynamodb:8000 \
          --table-name default_maps \
          --attribute-definitions AttributeName=default_key,AttributeType=S \
          --key-schema AttributeName=default_key,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || true
        aws dynamodb create-table \
          --endpoint-url http://dynamodb:8000 \
          --table-name game_instances \
          --attribute-definitions AttributeName=game_id,AttributeType=S \
          --key-schema AttributeName=game_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST || true
        aws dynamodb create-table \
          --endpoint-url http://dynamodb:8000 \
          --table-name game_steps \
          --attribute-definitions AttributeName=game_id,AttributeType=S AttributeName=step_seq,AttributeType=N AttributeName=command_id,AttributeType=S \
          --key-schema AttributeName=game_id,KeyType=HASH AttributeName=step_seq,KeyType=RANGE \
          --global-secondary-indexes '[{"IndexName":"command_id-index","KeySchema":[{"AttributeName":"command_id","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"}}]' \
          --billing-mode PAY_PER_REQUEST || true
        aws dynamodb create-table \
          --endpoint-url http://dynamodb:8000 \
          --table-name bot_players \
          --attribute-definitions AttributeName=game_id,AttributeType=S AttributeName=player_id,AttributeType=S AttributeName=bot_id,AttributeType=S \
          --key-schema AttributeName=game_id,KeyType=HASH AttributeName=player_id,KeyType=RANGE \
          --global-secondary-indexes '[{"IndexName":"bot_id-index","KeySchema":[{"AttributeName":"bot_id","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"}}]' \
          --billing-mode PAY_PER_REQUEST || true
        aws dynamodb create-table \
          --endpoint-url http://dynamodb:8000 \
          --table-name bot_llm_logs \
          --attribute-definitions AttributeName=game_id,AttributeType=S AttributeName=log_key,AttributeType=S \
          --key-schema AttributeName=game_id,KeyType=HASH AttributeName=log_key,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST || true
        echo "DynamoDB tables ensured."

  game-manager-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: game-manager-service
    depends_on:
      - kafka-init
      - dynamodb-init
    environment:
      GAME_MANAGER_BIND: 0.0.0.0:8081
      RUST_LOG: game_manager_service=info,tower_http=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      DEFAULT_MAP_CONFIG_PATH: /app/config/default-map.yaml
    volumes:
      - ./conf/default-map.yaml:/app/config/default-map.yaml:ro

  web-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: web-service
    depends_on:
      - kafka-init
    environment:
      WEB_SERVICE_BIND: 0.0.0.0:8082
      RUST_LOG: web_service=info,tower_http=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      GAME_SERVICE_BASE_URL: http://game-service:8084

  game-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: game-service
    depends_on:
      - kafka-init
      - dynamodb-init
    environment:
      GAME_SERVICE_BIND: 0.0.0.0:8084
      RUST_LOG: game_service=info
      GAME_MANAGER_BASE_URL: http://game-manager-service:8081
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local

  timer-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: timer-service
    depends_on:
      - kafka-init
    environment:
      RUST_LOG: timer_service=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  game-watcher-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: game-watcher-service
    depends_on:
      - kafka-init
      - dynamodb-init
    environment:
      WATCHER_SERVICE_BIND: 0.0.0.0:8083
      RUST_LOG: game_watcher_service=info,tower_http=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      GAME_MANAGER_BASE_URL: http://game-manager-service:8081
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local

  bot-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: bot-service
    depends_on:
      - kafka-init
      - game-manager-service
    environment:
      BOT_SERVICE_BIND: 0.0.0.0:8091
      RUST_LOG: bot_service=info,tower_http=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      GAME_MANAGER_BASE_URL: http://game-manager-service:8081
      BOT_AGENT_USE_DEEPAGENTS: "1"
      BOT_AGENT_MODEL: openai:gpt-4o-mini
      BOT_AGENT_PYTHON_BIN: python3
      BOT_AGENT_SCRIPT_PATH: /app/bot-agent/player_agent.py
      BOT_AGENT_REQUIREMENTS_PATH: /app/bot-agent/requirements.txt
      BOT_AGENT_AUTO_INSTALL_REQUIREMENTS: "1"
      BOT_AGENT_TIMEOUT_MS: "120000"
      BOT_AGENT_PROMPTS_CONFIG_PATH: /app/config/bot-service-prompts.yaml
      BOT_AGENT_LANGSMITH_CONFIG_PATH: /app/config/bot-service-langsmith.yaml
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      BOT_LLM_LOGS_TABLE: bot_llm_logs
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY:-}
    volumes:
      - ./conf/bot-service-prompts.yaml:/app/config/bot-service-prompts.yaml:ro
      - ./conf/bot-service-langsmith.yaml:/app/config/bot-service-langsmith.yaml:ro

  bot-manager-service:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        SERVICE: bot-manager-service
    depends_on:
      - kafka-init
      - dynamodb-init
      - bot-service
      - game-manager-service
    environment:
      BOT_MANAGER_BIND: 0.0.0.0:8090
      RUST_LOG: bot_manager_service=info,tower_http=info
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      GAME_MANAGER_BASE_URL: http://game-manager-service:8081
      BOT_SERVICE_BASE_URL: http://bot-service:8091
      BOT_SERVICE_BASE_URLS: http://bot-service:8091
      BOTS_PER_INSTANCE_CAPACITY: "2"
      BOT_MANAGER_LLM_CONFIG_PATH: /app/config/bot-manager-llm.yaml
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      BOT_STATE_TABLE: bot_players
      BOT_LLM_API_KEY: ${BOT_LLM_API_KEY:-}
    volumes:
      - ./conf/bot-manager-llm.yaml:/app/config/bot-manager-llm.yaml:ro

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - web-service
      - game-manager-service
      - game-watcher-service
    ports:
      - "8000:80"
    environment:
      COWBOY_SERVER: ${COWBOY_SERVER:-}
      COWBOY_SHOW_BOTS: ${COWBOY_SHOW_BOTS:-false}
    volumes:
      - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/start.sh:/docker-entrypoint.d/99-start-msg.sh:ro
      - ./frontend/index.html:/usr/share/nginx/html/index.html:ro
      - ./frontend/game.js:/usr/share/nginx/html/game.js:ro
      - ./frontend/assets:/usr/share/nginx/html/assets:ro
